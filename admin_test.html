<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Panel de Administración DISC - Prueba</title>
    <link rel="stylesheet" href="styles.css?v=1.4">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        .user-item {
            cursor: pointer;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            background-color: #f5f5f5;
            transition: background-color 0.2s;
        }
        
        .user-item:hover {
            background-color: #e0e0e0;
        }
        
        .users-list ul {
            list-style-type: none;
            padding: 0;
        }
        
        .admin-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .user-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .results-charts {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-between;
        }
        
        .chart-container {
            flex: 1;
            min-width: 300px;
            margin-bottom: 20px;
        }
        
        .user-details {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .results-charts {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="admin-section" class="section">
            <h1>Panel de Administración</h1>
            <p class="admin-description">Panel de visualización de resultados (versión de prueba)</p>
            
            <div class="admin-content">
                <div id="users-list-container">
                    <h3>Usuarios que han completado el cuestionario:</h3>
                    <div id="users-list" class="users-list">
                        <p>Cargando usuarios...</p>
                    </div>
                </div>
                
                <div id="user-results-container" class="hidden">
                    <div class="user-results-header">
                        <h3 id="selected-user-name"></h3>
                        <button id="back-to-users-btn" class="button">Volver a la lista</button>
                    </div>
                    <div class="results-charts">
                        <div class="chart-container">
                            <h4>Ámbito Laboral</h4>
                            <canvas id="admin-chart-trabajo"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>Ámbito Privado</h4>
                            <canvas id="admin-chart-privado"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="buttons-container">
                <button id="add-test-users-btn" class="button">Agregar usuarios de prueba</button>
                <button id="back-button" class="button" onclick="window.location.href='index.html'">Volver al cuestionario</button>
            </div>
        </div>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA30RkqEJZwdSd09xCBapixsj2POgYR40Q",
            authDomain: "disc-3dd13.firebaseapp.com",
            projectId: "disc-3dd13",
            storageBucket: "disc-3dd13.firebasestorage.app",
            messagingSenderId: "916126279471",
            appId: "1:916126279471:web:205e0addfaf4aa25e3a3da"
        };

        // Variables para Firebase
        let firebaseInitialized = false;
        let db = null;
        
        // Datos de usuarios de prueba
        const usuariosPrueba = [
            {
                nombre: "Test",
                resultados: {
                    trabajo: {
                        D: 35,
                        I: 28,
                        S: 15,
                        C: 20
                    },
                    privado: {
                        D: 25,
                        I: 38,
                        S: 18,
                        C: 19
                    }
                }
            },
            {
                nombre: "Juan Pérez",
                resultados: {
                    trabajo: {
                        D: 35,
                        I: 28,
                        S: 15,
                        C: 20
                    },
                    privado: {
                        D: 25,
                        I: 38,
                        S: 18,
                        C: 19
                    }
                }
            },
            {
                nombre: "María García",
                resultados: {
                    trabajo: {
                        D: 18,
                        I: 40,
                        S: 22,
                        C: 14
                    },
                    privado: {
                        D: 15,
                        I: 42,
                        S: 25,
                        C: 12
                    }
                }
            },
            {
                nombre: "Carlos Rodríguez",
                resultados: {
                    trabajo: {
                        D: 42,
                        I: 15,
                        S: 18,
                        C: 30
                    },
                    privado: {
                        D: 38,
                        I: 20,
                        S: 22,
                        C: 32
                    }
                }
            }
        ];

        // Intentar inicializar Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase inicializado correctamente");
            firebaseInitialized = true;
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            console.log("La aplicación funcionará en modo local sin conexión a Firebase");
        }

        // Eventos al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar lista de usuarios
            cargarListaUsuarios();
            
            // Configurar eventos
            document.getElementById('back-to-users-btn').addEventListener('click', function() {
                document.getElementById('user-results-container').classList.add('hidden');
                document.getElementById('users-list-container').classList.remove('hidden');
            });
            
            document.getElementById('add-test-users-btn').addEventListener('click', function() {
                agregarUsuariosPrueba();
            });
        });
        
        // Función para cargar la lista de usuarios
        function cargarListaUsuarios() {
            const usersListContainer = document.getElementById('users-list');
            usersListContainer.innerHTML = '<p>Cargando usuarios...</p>';
            
            if (!firebaseInitialized) {
                // Si Firebase no está disponible, muestra mensaje para añadir usuarios de prueba
                usersListContainer.innerHTML = '<p>Firebase no está disponible. Haz clic en "Agregar usuarios de prueba" para simular datos.</p>';
                return;
            }
            
            // Obtener usuarios desde Firebase
            db.collection("resultados_disc").get()
                .then((querySnapshot) => {
                    const usuarios = [];
                    
                    querySnapshot.forEach((doc) => {
                        usuarios.push(doc.id); // doc.id contiene el nombre del usuario
                    });
                    
                    // Mostrar mensaje si no hay usuarios
                    if (usuarios.length === 0) {
                        usersListContainer.innerHTML = '<p class="no-users">No hay usuarios que hayan completado el cuestionario. Haz clic en "Agregar usuarios de prueba".</p>';
                        return;
                    }
                    
                    // Crear la lista de usuarios
                    const ul = document.createElement('ul');
                    
                    usuarios.forEach(usuario => {
                        const li = document.createElement('li');
                        li.className = 'user-item';
                        li.textContent = usuario;
                        li.addEventListener('click', () => mostrarResultadosUsuario(usuario));
                        ul.appendChild(li);
                    });
                    
                    usersListContainer.innerHTML = '';
                    usersListContainer.appendChild(ul);
                })
                .catch((error) => {
                    console.error("Error al cargar usuarios desde Firebase:", error);
                    usersListContainer.innerHTML = '<p class="error">Error al cargar la lista de usuarios. Haz clic en "Agregar usuarios de prueba".</p>';
                });
        }
        
        // Función para mostrar los resultados de un usuario específico
        function mostrarResultadosUsuario(usuario) {
            // Obtener los contenedores
            const usersListContainer = document.getElementById('users-list-container');
            const userResultsContainer = document.getElementById('user-results-container');
            
            // Ocultar lista y mostrar resultados
            usersListContainer.classList.add('hidden');
            userResultsContainer.classList.remove('hidden');
            
            // Mostrar el nombre del usuario seleccionado
            document.getElementById('selected-user-name').textContent = `Resultados de ${usuario}`;
            
            if (!firebaseInitialized) {
                userResultsContainer.innerHTML = '<p class="error">Firebase no está disponible para obtener resultados.</p>';
                return;
            }
            
            // Obtener los resultados desde Firebase
            db.collection("resultados_disc").doc(usuario).get()
                .then((doc) => {
                    if (doc.exists) {
                        const datosUsuario = doc.data();
                        const resultadosUsuario = datosUsuario.resultados;
                        
                        // Limpiar canvas previos si existen
                        const trabajoCanvas = document.getElementById('admin-chart-trabajo');
                        const privadoCanvas = document.getElementById('admin-chart-privado');
                        
                        // Asegurarse de que los canvas estén limpios
                        const trabajoCtx = trabajoCanvas.getContext('2d');
                        const privadoCtx = privadoCanvas.getContext('2d');
                        
                        trabajoCtx.clearRect(0, 0, trabajoCanvas.width, trabajoCanvas.height);
                        privadoCtx.clearRect(0, 0, privadoCanvas.width, privadoCanvas.height);
                        
                        // Crear gráficos
                        createChart('admin-chart-trabajo', resultadosUsuario.trabajo, 'Ámbito Laboral');
                        createChart('admin-chart-privado', resultadosUsuario.privado, 'Ámbito Privado');
                        
                        // Mostrar fecha del test
                        const fechaTest = datosUsuario.fecha ? new Date(datosUsuario.fecha.toDate()) : new Date();
                        const fechaFormateada = fechaTest.toLocaleDateString() + ' ' + fechaTest.toLocaleTimeString();
                        
                        // Añadir detalles adicionales
                        const detalles = document.createElement('div');
                        detalles.className = 'user-details';
                        detalles.innerHTML = `
                            <p><strong>Fecha:</strong> ${fechaFormateada}</p>
                        `;
                        
                        // Añadir detalles antes de los gráficos
                        const headerContainer = document.querySelector('.user-results-header');
                        if (headerContainer.querySelector('.user-details')) {
                            headerContainer.querySelector('.user-details').remove();
                        }
                        headerContainer.appendChild(detalles);
                        
                    } else {
                        userResultsContainer.innerHTML = `<p>No se encontraron resultados para ${usuario}</p>`;
                    }
                })
                .catch((error) => {
                    console.error("Error al obtener resultados desde Firebase:", error);
                    userResultsContainer.innerHTML = `<p class="error">Error al cargar los resultados.</p>`;
                });
        }
        
        // Función para agregar usuarios de prueba
        function agregarUsuariosPrueba() {
            if (!firebaseInitialized) {
                alert('Firebase no está disponible. No se pueden agregar usuarios de prueba.');
                return;
            }
            
            // Deshabilitar botón mientras se agregan los usuarios
            const addButton = document.getElementById('add-test-users-btn');
            addButton.disabled = true;
            addButton.textContent = 'Agregando usuarios...';
            
            // Contador para usuarios agregados
            let usuariosAgregados = 0;
            
            // Agregar cada usuario de prueba
            usuariosPrueba.forEach(usuario => {
                const datosUsuario = {
                    nombre: usuario.nombre,
                    fecha: new Date(),
                    resultados: usuario.resultados,
                    dispositivo: navigator.userAgent
                };
                
                db.collection("resultados_disc").doc(usuario.nombre).set(datosUsuario)
                    .then(() => {
                        console.log(`Usuario ${usuario.nombre} agregado correctamente`);
                        usuariosAgregados++;
                        
                        // Cuando se hayan agregado todos, recargar la lista
                        if (usuariosAgregados === usuariosPrueba.length) {
                            cargarListaUsuarios();
                            addButton.disabled = false;
                            addButton.textContent = 'Agregar usuarios de prueba';
                        }
                    })
                    .catch((error) => {
                        console.error(`Error al agregar usuario ${usuario.nombre}:`, error);
                        
                        // Incluso si hay error, continuar con el conteo
                        usuariosAgregados++;
                        if (usuariosAgregados === usuariosPrueba.length) {
                            cargarListaUsuarios();
                            addButton.disabled = false;
                            addButton.textContent = 'Agregar usuarios de prueba';
                        }
                    });
            });
        }
        
        // Crear gráfico de resultados
        function createChart(canvasId, data, title) {
            console.log(`Creando gráfico para ${canvasId} con datos:`, data);
            
            // Obtener el elemento canvas
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`No se encontró el canvas con ID ${canvasId}`);
                return;
            }
            
            // Obtener el contexto del canvas
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error(`No se pudo obtener el contexto 2D del canvas ${canvasId}`);
                return;
            }
            
            // Crear nuevo gráfico
            try {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['D (Dominancia)', 'I (Influencia)', 'S (Estabilidad)', 'C (Cumplimiento)'],
                        datasets: [{
                            label: title,
                            data: [data.D, data.I, data.S, data.C],
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 56, // Máximo teórico (14 grupos x 4 puntos máximo)
                                title: {
                                    display: true,
                                    text: 'Puntuación'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: title,
                                font: {
                                    size: 18
                                }
                            },
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                console.log(`Gráfico para ${canvasId} creado con éxito`);
            } catch (error) {
                console.error(`Error al crear el gráfico para ${canvasId}:`, error);
                throw error;
            }
        }
    </script>
</body>
</html> 