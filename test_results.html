<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visor de Resultados DISC de Prueba</title>
    <link rel="stylesheet" href="styles.css?v=1.4">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <div id="test-results-section" class="section">
            <h1>Visor de Resultados DISC de Prueba</h1>
            <p class="test-description">Esta página muestra resultados de prueba sin necesidad de completar el cuestionario completo.</p>

            <div id="results-section" class="section">
                <h2>Resultados de Usuario de Prueba</h2>
                <div class="results-container">
                    <div class="chart-section">
                        <h3>Ámbito Laboral</h3>
                        <div class="chart-container">
                            <canvas id="chart-trabajo"></canvas>
                        </div>
                    </div>
                    <div class="chart-section">
                        <h3>Ámbito Privado</h3>
                        <div class="chart-container">
                            <canvas id="chart-privado"></canvas>
                        </div>
                    </div>
                </div>
                <div class="explanation">
                    <h3>Explicación de los resultados</h3>
                    <div id="resultados-texto"></div>
                </div>
                <div class="buttons-container">
                    <button id="save-to-firebase-btn" class="button">Guardar datos en Firestore</button>
                    <button id="back-button" class="button" onclick="window.location.href='index.html'">Volver al cuestionario</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA30RkqEJZwdSd09xCBapixsj2POgYR40Q",
            authDomain: "disc-3dd13.firebaseapp.com",
            projectId: "disc-3dd13",
            storageBucket: "disc-3dd13.firebasestorage.app",
            messagingSenderId: "916126279471",
            appId: "1:916126279471:web:205e0addfaf4aa25e3a3da"
        };

        // Variables para Firebase
        let firebaseInitialized = false;
        let db = null;

        // Datos de prueba (resultados ficticios)
        const usuarioPrueba = "Test";
        const resultadosPrueba = {
            trabajo: {
                D: 35,
                I: 28,
                S: 15,
                C: 20
            },
            privado: {
                D: 25,
                I: 38,
                S: 18,
                C: 19
            }
        };

        // Intentar inicializar Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase inicializado correctamente");
            firebaseInitialized = true;
            
            // Ya no guardaremos automáticamente al inicializar
            // Ahora lo haremos con un botón explícito
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            console.log("La aplicación funcionará en modo local sin conexión a Firebase");
        }

        // Función para guardar datos de prueba en Firestore
        function guardarDatosPrueba() {
            if (!firebaseInitialized || !db) {
                alert("Firebase no está disponible. No se pueden guardar los datos.");
                return;
            }
            
            // Mostrar indicador de carga
            const saveButton = document.getElementById('save-to-firebase-btn');
            saveButton.disabled = true;
            saveButton.textContent = 'Guardando...';
            
            // Verificar el estado de la conexión
            console.log("Estado de Firebase:", {
                inicializado: firebaseInitialized,
                db: !!db,
                configuración: firebaseConfig
            });
            
            const datosUsuario = {
                nombre: usuarioPrueba,
                fecha: new Date(),
                resultados: resultadosPrueba,
                dispositivo: navigator.userAgent,
                timestamp: firebase.firestore.FieldValue.serverTimestamp() // Añadir timestamp para verificar
            };
            
            console.log("Intentando guardar datos en Firestore:", datosUsuario);
            console.log("Colección: resultados_disc, Documento: " + usuarioPrueba);
            
            // Primero verificamos si tenemos acceso de lectura
            db.collection("resultados_disc").get()
                .then(snapshot => {
                    console.log("Verificación de lectura exitosa. Documentos encontrados:", snapshot.size);
                    
                    // Ahora intentamos escribir
                    return db.collection("resultados_disc").doc(usuarioPrueba).set(datosUsuario);
                })
                .then(() => {
                    console.log("Datos de prueba guardados correctamente en Firebase");
                    saveButton.textContent = '¡Datos guardados correctamente!';
                    
                    // Verificar que se guardaron correctamente intentando leerlos de nuevo
                    return db.collection("resultados_disc").doc(usuarioPrueba).get();
                })
                .then(docSnapshot => {
                    if (docSnapshot.exists) {
                        console.log("Verificación: Documento recuperado correctamente:", docSnapshot.data());
                    } else {
                        console.error("Verificación: ¡El documento no existe después de guardarlo!");
                    }
                    
                    // Restaurar botón después de 3 segundos
                    setTimeout(() => {
                        saveButton.disabled = false;
                        saveButton.textContent = 'Guardar datos en Firestore';
                    }, 3000);
                    
                    // También guardar en localStorage como respaldo
                    try {
                        localStorage.setItem(`resultados_${usuarioPrueba}`, JSON.stringify({
                            ...datosUsuario,
                            fecha: datosUsuario.fecha.toISOString(), // Convertir fecha a formato serializable
                            timestamp: null // No podemos serializar el timestamp de Firestore
                        }));
                        console.log("Datos también guardados en localStorage");
                    } catch (err) {
                        console.error("Error al guardar en localStorage:", err);
                    }
                })
                .catch((error) => {
                    console.error("Error al guardar datos de prueba en Firebase:", error);
                    console.error("Código de error:", error.code);
                    console.error("Mensaje de error:", error.message);
                    
                    if (error.code === 'permission-denied') {
                        alert("Error de permisos: Verifica las reglas de seguridad en la consola de Firebase.");
                        console.error("Esto generalmente significa que las reglas de seguridad de Firestore están bloqueando la operación.");
                        console.error("Ve a la consola de Firebase -> Firestore Database -> Rules y asegúrate de que las reglas permitan escritura.");
                    }
                    
                    saveButton.textContent = 'Error al guardar datos';
                    // Restaurar botón después de 3 segundos
                    setTimeout(() => {
                        saveButton.disabled = false;
                        saveButton.textContent = 'Guardar datos en Firestore';
                    }, 3000);
                });
        }

        // Mostrar resultados de prueba al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Mostrar resultados directamente
            mostrarResultados();
            
            // Configurar botón para guardar en Firestore
            const saveButton = document.getElementById('save-to-firebase-btn');
            if (saveButton) {
                saveButton.addEventListener('click', guardarDatosPrueba);
                
                // Deshabilitar botón si Firebase no está disponible
                if (!firebaseInitialized) {
                    saveButton.disabled = true;
                    saveButton.textContent = 'Firebase no disponible';
                }
            }
        });

        // Función para mostrar resultados
        function mostrarResultados() {
            try {
                // Crear gráficos para ambos ámbitos
                createChart('chart-trabajo', resultadosPrueba.trabajo, 'Ámbito Laboral');
                createChart('chart-privado', resultadosPrueba.privado, 'Ámbito Privado');
                
                // Generar texto de explicación
                const resultadosTexto = document.getElementById('resultados-texto');
                if (resultadosTexto) {
                    resultadosTexto.innerHTML = `
                        <p><strong>Usuario:</strong> ${usuarioPrueba}</p>
                        <p>Estos resultados muestran un perfil DISC de prueba en los ámbitos laboral y privado.</p>
                        <ul>
                            <li><strong>D (Dominancia):</strong> ${resultadosPrueba.trabajo.D} en trabajo, ${resultadosPrueba.privado.D} en privado</li>
                            <li><strong>I (Influencia):</strong> ${resultadosPrueba.trabajo.I} en trabajo, ${resultadosPrueba.privado.I} en privado</li>
                            <li><strong>S (Estabilidad):</strong> ${resultadosPrueba.trabajo.S} en trabajo, ${resultadosPrueba.privado.S} en privado</li>
                            <li><strong>C (Cumplimiento):</strong> ${resultadosPrueba.trabajo.C} en trabajo, ${resultadosPrueba.privado.C} en privado</li>
                        </ul>
                        <p><strong>Interpretación:</strong></p>
                        <p>En el ámbito laboral, este perfil muestra una alta Dominancia (D) e Influencia (I), lo que indica una persona asertiva, orientada a resultados y sociable. La baja puntuación en Estabilidad (S) sugiere adaptabilidad al cambio.</p>
                        <p>En el ámbito privado, destaca la Influencia (I), lo que muestra una personalidad más social y expresiva en entornos personales.</p>
                    `;
                }
            } catch (error) {
                console.error('Error al mostrar resultados:', error);
                alert('Hubo un error al mostrar los resultados. Por favor, recarga la página e inténtalo de nuevo.');
            }
        }

        // Crear gráfico de resultados
        function createChart(canvasId, data, title) {
            console.log(`Creando gráfico para ${canvasId} con datos:`, data);
            
            // Obtener el elemento canvas
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`No se encontró el canvas con ID ${canvasId}`);
                return;
            }
            
            // Obtener el contexto del canvas
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error(`No se pudo obtener el contexto 2D del canvas ${canvasId}`);
                return;
            }
            
            // Crear nuevo gráfico
            try {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['D (Dominancia)', 'I (Influencia)', 'S (Estabilidad)', 'C (Cumplimiento)'],
                        datasets: [{
                            label: title,
                            data: [data.D, data.I, data.S, data.C],
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 56, // Máximo teórico (14 grupos x 4 puntos máximo)
                                title: {
                                    display: true,
                                    text: 'Puntuación'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: title,
                                font: {
                                    size: 18
                                }
                            },
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                console.log(`Gráfico para ${canvasId} creado con éxito`);
            } catch (error) {
                console.error(`Error al crear el gráfico para ${canvasId}:`, error);
                throw error;
            }
        }
    </script>
</body>
</html> 